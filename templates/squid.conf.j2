https_port 443 accel defaultsite={{ ansible_domain }} cert={{ squid_ssl_cert_file }} key={{ squid_ssl_key_file }} options=NO_SSLv3:NO_SSLv2:CIPHER_SERVER_PREFERENCE cipher=ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:!ECDHE-RSA-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!AES256-GCM-SHA384:!AES128-GCM-SHA256:!AES256-SHA256:!AES128-SHA256:!AES256-SHA:!AES128-SHA:!DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK:!RC4 dhparams={{ squid_dhparam_pem_file }} sslflags=NO_SESSION_REUSE
http_port 80 accel defaultsite={{ ansible_domain }} ssl-bump 

cache_dir ufs /var/spool/squid {{ squid_cache_mb }} {{ squid_cache_l1 }} {{ squid_cache_l2 }}
sslproxy_flags DONT_VERIFY_PEER

{% for host in squid_backend_servers %}
{% if 'blog' not in host.name %}
acl {{ host.name }} urlpath_regex ^/{{ host.name }}
{% else %}
acl {{ host.name }} dstdomain {{ ansible_domain }}
{% endif %}
{% endfor %}
acl ssl_redirect localport 80

http_access deny ssl_redirect blog
deny_info https://%H%R blog

{% for host in squid_backend_servers %}
cache_peer {{ host.ip }} parent {{ host.port }} 0 no-query originserver name={{ host.name }} ssl sslflags=DONT_VERIFY_PEER login=PASS options=NO_SSLv3:NO_SSLv2 cipher=ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:!ECDHE-RSA-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!AES256-GCM-SHA384:!AES128-GCM-SHA256:!AES256-SHA256:!AES128-SHA256:!AES256-SHA:!AES128-SHA:!DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!3DES:!MD5:!PSK:!RC4 dhparams={{ squid_dhparam_pem_file }} sslflags=NO_SESSION_REUSE
{% if 'blog' in host.name %}
{% for deny_host in squid_backend_servers %}
{% if deny_host.name != 'blog' %}
cache_peer_access {{ host.name }} deny {{ deny_host.name }}
{% endif %}
{% endfor %}
http_access allow {{ host.name }}
{% else %}
cache_peer_access {{ host.name }} allow {{ host.name }}
cache_peer_access {{ host.name }} deny all
no_cache deny {{ host.name }}
http_access allow {{ host.name }}

{% endif %}
{% endfor %}

http_access deny to_localhost
http_access deny all

access_log /var/log/squid/access.log squid
